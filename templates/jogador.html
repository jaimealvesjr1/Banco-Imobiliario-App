{% extends "base.html" %}
{% block title %}Carteira: {{ dados_jogador.name }}{% endblock %}

{% block content %}
<div class="max-w-md mx-auto pb-10 space-y-4"> 
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed top-2 left-2 right-2 z-50 space-y-2 pointer-events-none">
                {% for category, message in messages %}
                <div class="p-3 rounded-xl shadow-xl border-2 bg-white/95 backdrop-blur text-center font-black text-[10px] uppercase {{ 'text-red-600 border-red-200' if category == 'error' else 'text-green-600 border-green-200' }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header style="background-color: {{ dados_jogador.color }}" class="relative text-white p-6 rounded-[2.5rem] shadow-2xl border-b-8 border-black/10 overflow-hidden">
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center font-black text-xs">{{ dados_jogador.name[0].upper() }}</div>
                <p class="font-bold text-sm tracking-tight">{{ dados_jogador.name }}</p>
            </div>
            <a href="{{ url_for('logout_jogador', player_id=player_id) }}" class="p-2 bg-black/10 rounded-full text-xs">üîí</a>
        </div>
        <p class="text-[9px] font-black uppercase opacity-60 tracking-[0.2em] mb-1">Saldo em Conta</p>
        <h1 class="text-4xl font-black font-mono tracking-tighter">
            <span class="text-xl opacity-40">R$</span> {{ dados_jogador.saldo | format_brl }}
        </h1>
        
        <div class="mt-4 pt-4 border-t border-white/10">
            <button onclick="toggleObjetivo()" class="flex items-center gap-2 text-[8px] font-black uppercase tracking-widest text-white/80">
                <span>üìú Miss√£o Secreta:</span>
                <span id="obj-status" class="bg-black/20 px-2 py-0.5 rounded">REVELAR</span>
            </button>
            <p id="obj-content" class="hidden mt-2 text-[10px] italic font-medium leading-tight text-white/90">"{{ dados_jogador.objetivo }}"</p>
        </div>
    </header>

    <section class="flex gap-3 overflow-x-auto snap-x pb-2 px-1 scrollbar-hide">
        {% for m in MANCHETES_VIGENTES %}
        <div class="min-w-[85%] bg-white p-3 rounded-2xl shadow-sm border-l-4 {{ 'border-red-600' if loop.first else 'border-gray-300' }} snap-center">
            <div class="flex justify-between items-start mb-1">
                <h4 class="text-[10px] font-black uppercase italic">{{ m.titulo }}</h4>
                <span class="text-[7px] font-bold text-gray-400">{{ m.data_hora }}</span>
            </div>
            <p class="text-[9px] text-gray-600 leading-tight mb-2">{{ m.texto }}</p>
            <div class="bg-red-50 p-1.5 rounded-lg border border-red-100">
                <p class="text-[9px] font-black text-red-600 uppercase italic">Efeito: {{ m.efeito }}</p>
            </div>
        </div>
        {% endfor %}
    </section>

    <section class="bg-white p-5 rounded-3xl shadow-lg border border-gray-100">
        <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 text-center">Efetuar Pagamento</h3>
        <form method="POST" action="{{ url_for('transacao') }}" class="space-y-4" id="pixForm">
            <input type="hidden" name="remetente_id" value="{{ player_id }}">
            
            <select name="recebedor_id" required class="w-full p-3 bg-gray-50 rounded-xl font-bold text-xs border-2 border-transparent focus:border-red-400 outline-none">
                <option value="">Destinat√°rio...</option>
                {% for dest_id, dest_name in destinatarios %}<option value="{{ dest_id }}">{{ dest_name }}</option>{% endfor %}
            </select>

            <div class="grid grid-cols-3 gap-2">
                <div class="col-span-2">
                    <label class="text-[8px] font-black text-gray-400 uppercase ml-2">Valor Base</label>
                    <input type="number" id="valor_base" required placeholder="Ex: 20000" class="w-full p-3 bg-gray-50 rounded-xl font-black text-lg font-mono outline-none border-2 border-transparent focus:border-red-400">
                </div>
                <div>
                    <label class="text-[8px] font-black text-gray-400 uppercase ml-2">Mult.</label>
                    <select id="multiplicador" class="w-full p-3 bg-gray-100 rounded-xl font-black text-lg outline-none">
                        {% for i in range(1, 13) %}<option value="{{ i }}">x{{ i }}</option>{% endfor %}
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-1.5">
                {% for pct in [-20, -10, 10, 20] %}
                <button type="button" onclick="atualizarCalculo({{ pct }})" class="py-2 rounded-lg text-[9px] font-black border-2 border-gray-100 hover:bg-red-50 hover:border-red-200 transition-all">
                    {{ '+' if pct > 0 }}{{ pct }}%
                </button>
                {% endfor %}
            </div>

            <div class="p-4 bg-gray-900 rounded-2xl border-t-4 border-red-500 text-white">
                <div class="flex justify-between text-[8px] font-bold text-gray-400 uppercase mb-1">
                    <span>F√≥rmula de C√°lculo</span>
                    <span id="formula_display">R$ 0 x 1 (+0%)</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-black text-sm uppercase italic text-red-400">Total:</span>
                    <span id="valor_final_display" class="font-mono font-black text-2xl text-white tracking-tighter">R$ 0</span>
                    <input type="hidden" name="valor" id="valor_final_input" value="0">
                </div>
            </div>

            <button type="submit" class="w-full bg-red-500 text-white py-4 rounded-2xl font-black text-xs uppercase italic shadow-lg active:scale-95 transition-all">
                Confirmar e Enviar PIX ‚ö°
            </button>
        </form>
    </section>

    <div class="grid grid-cols-2 gap-3">
        <section class="bg-indigo-900 text-white p-4 rounded-3xl shadow-lg">
            <p class="text-[8px] font-black uppercase text-indigo-300 mb-1">Poupan√ßa</p>
            <h2 class="text-xl font-black font-mono leading-none mb-3">R$ {{ dados_jogador.poupanca | format_brl }}</h2>
            <form method="POST" action="{{ url_for('poupanca_jogador', player_id=player_id) }}" class="flex gap-1">
                <input type="number" name="valor" placeholder="R$" class="w-full p-1.5 bg-white/10 rounded-lg text-[10px] font-black border border-white/5">
                <button type="submit" name="action" value="investir" class="bg-white text-indigo-900 px-2 rounded-lg text-[10px]">‚¨ÜÔ∏è</button>
            </form>
        </section>

        <section class="bg-green-100 p-4 rounded-3xl border border-green-200">
            <p class="text-[8px] font-black uppercase text-green-600 mb-1">Ponto de Partida</p>
            <form method="POST" action="{{ url_for('solicitar_salario', player_id=player_id) }}" class="space-y-2">
                <input type="number" name="num_propriedades" placeholder="Posses" required class="w-full p-1.5 bg-white rounded-lg text-[10px] font-bold border border-green-200">
                <button type="submit" class="w-full bg-green-600 text-white py-1.5 rounded-lg text-[8px] font-black uppercase">Clamar üí∞</button>
            </form>
        </section>

        <section class="col-span-2 bg-blue-50 p-4 rounded-3xl border border-blue-100">
            <button onclick="document.getElementById('form-parcelamento').classList.toggle('hidden')" class="w-full flex justify-between items-center text-blue-600">
                <span class="text-[10px] font-black uppercase tracking-widest">Emitir Cobran√ßa Parcelada</span>
                <span class="text-xs">‚ûï</span>
            </button>
            <form id="form-parcelamento" method="POST" action="{{ url_for('criar_cobranca_parcelada', credor_id=player_id) }}" class="hidden mt-3 space-y-2">
                <select name="devedor_id" required class="w-full p-2 bg-white rounded-lg border border-blue-200 text-[10px] font-bold outline-none">
                    <option value="">Para quem?</option>
                    {% for dest_id, dest_name in destinatarios if dest_id != 'Banco' %}<option value="{{ dest_id }}">{{ dest_name }}</option>{% endfor %}
                </select>
                <div class="flex gap-2">
                    <input type="number" name="valor_total" placeholder="Total R$" class="flex-1 p-2 bg-white rounded-lg border border-blue-200 text-[10px] font-bold">
                    <input type="number" name="num_parcelas" placeholder="Vezes" min="1" max="12" class="w-16 p-2 bg-white rounded-lg border border-blue-200 text-[10px] font-bold text-center">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl font-black text-[10px] uppercase italic">Gerar Carn√™</button>
            </form>
        </section>
    </div>

    {% set minhas_dividas = [] %}
    {% for inst_id, cobranca in COBRANCAS_PARCELADAS.items() %}
        {% if cobranca.devedor_id == player_id %}{% set _ = minhas_dividas.append(cobranca) %}{% endif %}
    {% endfor %}

    {% if minhas_dividas %}
    <section class="px-1">
        <h3 class="text-[10px] font-black text-red-500 uppercase tracking-widest mb-2">Meus Carn√™s (A Pagar)</h3>
        <div class="space-y-2">
            {% for inst_id, cobranca in COBRANCAS_PARCELADAS.items() if cobranca.devedor_id == player_id %}
            <div class="bg-red-50 p-3 rounded-2xl border border-red-100 flex justify-between items-center">
                <div class="text-[9px] font-black">
                    <p class="text-gray-800">{{ cobranca.num_parcelas_pagas }}/{{ cobranca.num_parcelas_total }}x de R$ {{ (cobranca.valor_primeira_parcela if cobranca.num_parcelas_pagas == 0 else cobranca.valor_outras_parcelas) | format_brl }}</p>
                    <p class="text-red-400">Para: {{ id_to_name.get(cobranca.credor_id, 'Banco') }}</p>
                </div>
                <form method="POST" action="{{ url_for('pagar_cobranca_parcelada', devedor_id=player_id, installment_id=inst_id) }}">
                    <button type="submit" class="bg-red-600 text-white px-3 py-2 rounded-lg text-[8px] font-black uppercase">Pagar</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="px-1">
        <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 text-center">√öltimas Movimenta√ß√µes</h3>
        <div class="space-y-1">
            {% for t in historico[:5] %}
                {% set incoming = t.recebedor_id == player_id %}
                <div class="bg-white px-3 py-2 rounded-xl flex justify-between items-center text-[10px] border border-gray-50">
                    <span class="font-black text-gray-500">{{ '‚¨ÜÔ∏è' if incoming else '‚¨áÔ∏è' }} {{ id_to_name.get(t.remetente_id if incoming else t.recebedor_id, 'Banco') }}</span>
                    <span class="font-mono font-black {{ 'text-green-600' if incoming else 'text-red-500' }}">
                        {{ '+' if incoming else '-' }}R$ {{ t.valor | format_brl }}
                    </span>
                </div>
            {% endfor %}
        </div>
    </section>

    <script>
        // L√ìGICA DA CALCULADORA UNIFICADA
        let boostAtual = 0;
        function atualizarCalculo(novoBoost = null) {
            if (novoBoost !== null) boostAtual = novoBoost;
            const base = parseFloat(document.getElementById('valor_base').value) || 0;
            const mult = parseInt(document.getElementById('multiplicador').value) || 1;
            const subtotal = base * mult;
            const final = Math.round(subtotal + (subtotal * (boostAtual / 100)));
            
            document.getElementById('valor_final_input').value = final;
            document.getElementById('valor_final_display').innerText = "R$ " + final.toLocaleString('pt-BR');
            document.getElementById('formula_display').innerText = `R$ ${base.toLocaleString('pt-BR')} x ${mult} (${boostAtual >= 0 ? '+' : ''}${boostAtual}%)`;
        }

        document.getElementById('valor_base').addEventListener('input', () => atualizarCalculo());
        document.getElementById('multiplicador').addEventListener('change', () => atualizarCalculo());

        function toggleObjetivo() {
            const content = document.getElementById('obj-content');
            const status = document.getElementById('obj-status');
            content.classList.toggle('hidden');
            status.innerText = content.classList.contains('hidden') ? 'REVELAR' : 'OCULTAR';
        }
    </script>
</div>
{% endblock %}
