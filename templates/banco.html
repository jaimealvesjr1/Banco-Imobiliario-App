{% extends "base.html" %}

{% block title %}Painel Administrativo - Banco Central{% endblock %}

{% block content %}
<div class="min-h-screen pb-10">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for category, message in messages %}
                    <div class="flex items-center gap-3 p-4 rounded-xl border-2 shadow-sm animate-pulse
                        {% if category == 'error' or category == 'warning' %}
                            bg-red-50 text-red-700 border-red-200
                        {% else %}
                            bg-green-50 text-green-700 border-green-200
                        {% endif %}">
                        <span class="text-xl">{% if category == 'error' %}‚ö†Ô∏è{% else %}‚úÖ{% endif %}</span>
                        <p class="font-bold">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="bg-monopoly-dark text-white p-6 rounded-2xl mb-8 shadow-2xl border-b-4 border-monopoly-blue">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm">
                    <span class="text-4xl">üèõÔ∏è</span>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight italic uppercase">Banco Central</h1>
                    <p class="text-monopoly-blue text-[10px] font-bold tracking-widest uppercase opacity-80">Gest√£o de Liquidez e Ativos</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('dashboard') }}" class="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-full text-xs font-bold transition-all border border-white/20 uppercase">Menu</a>
                <a href="{{ url_for('banco_logout') }}" class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-full text-xs font-black shadow-lg uppercase">Sair üîí</a>
            </div>
        </div>
    </header>

    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
        {% for player_id, data in jogadores_data.items() %}
            <div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-gray-100 group flex flex-col h-full hover:border-monopoly-blue transition-colors">
                <div class="h-1.5 w-full" style="background-color: {{ data.color }}"></div>
                <div class="p-4 flex flex-col justify-between flex-grow">
                    <div class="mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-black text-gray-800 uppercase text-[10px] truncate" title="{{ data.name }}">{{ data.name }}</h3>
                            <form method="POST" action="{{ url_for('reset_pin', player_id=player_id) }}">
                                <button type="submit" title="Resetar PIN" class="text-gray-200 hover:text-yellow-500 transition-colors">üîë</button>
                            </form>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[8px] font-black text-gray-400 uppercase tracking-tighter">Saldo em Conta</p>
                            <p class="text-lg font-black text-gray-900 font-mono leading-none">R$ {{ data.saldo | format_brl }}</p>
                        </div>
                    </div>
                    <div class="pt-3 border-t border-gray-50 flex justify-between items-center">
                        <div class="text-left">
                            <p class="text-[7px] font-black text-indigo-400 uppercase">Poupan√ßa</p>
                            <p class="font-mono font-bold text-indigo-700 text-[10px]">R$ {{ data.poupanca | format_brl }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[7px] font-black text-gray-400 uppercase">Total</p>
                            <p class="font-mono font-black text-gray-800 text-[10px]">R$ {{ (data.saldo + data.poupanca) | format_brl }}</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </section>

    <div class="grid lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">üí∏</span>
                <h2 class="text-xl font-black text-gray-800 uppercase italic">Transa√ß√µes</h2>
            </div>
            
            <form method="POST" action="{{ url_for('transacao_unificada') }}" class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Alvo da Opera√ß√£o</label>
                    <select name="target_id" required class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold focus:border-monopoly-blue outline-none transition-all appearance-none">
                        <option value="">Selecione...</option>
                        <optgroup label="Individuais">
                            {% for player_id, data in jogadores_data.items() %}
                                <option value="{{ player_id }}">{{ data.name }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Coletivas">
                            <option value="Todos" class="font-black text-indigo-600">TODOS OS JOGADORES</option>
                        </optgroup>
                    </select>
                </div>

                <div class="bg-gray-100 p-2 rounded-xl flex gap-1">
                    <label class="flex-1">
                        <input type="radio" name="value_type" value="FIXO" checked onclick="toggleAdj(true)" class="hidden peer">
                        <div class="text-center py-2 rounded-lg text-[10px] font-black peer-checked:bg-white peer-checked:shadow-sm text-gray-400 peer-checked:text-monopoly-dark cursor-pointer transition-all uppercase">Dinheiro</div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="value_type" value="PCT" onclick="toggleAdj(false)" class="hidden peer">
                        <div class="text-center py-2 rounded-lg text-[10px] font-black peer-checked:bg-white peer-checked:shadow-sm text-gray-400 peer-checked:text-monopoly-dark cursor-pointer transition-all uppercase">Porcentagem</div>
                    </label>
                </div>

                <div class="space-y-4">
                    <div id="valor_container">
                        <label id="valor_label" class="block text-[10px] font-black text-gray-400 uppercase mb-1">Valor Nominal (R$)</label>
                        <input type="number" name="valor" id="valor_input" required class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl font-mono text-2xl font-black" placeholder="0">
                    </div>

                    <div id="ajuste_container" class="p-4 bg-blue-50/50 rounded-2xl border border-blue-100">
                        <label class="block text-[10px] font-black text-blue-800 uppercase mb-1">Ajuste de Taxa (%)</label>
                        <input type="number" name="ajuste_pct" id="ajuste_pct" value="0" class="w-full bg-transparent font-mono text-2xl font-black text-blue-900 outline-none" placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button type="submit" name="action_type_final" value="COBRAR" class="bg-red-600 p-4 rounded-2xl font-black text-white shadow-lg hover:bg-red-700 active:scale-95 transition-all uppercase italic text-xs">Debitar ‚¨áÔ∏è</button>
                    <button type="submit" name="action_type_final" value="PAGAR" class="bg-green-600 p-4 rounded-2xl font-black text-white shadow-lg hover:bg-green-700 active:scale-95 transition-all uppercase italic text-xs">Creditar ‚¨ÜÔ∏è</button>
                </div>
            </form>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üí∞</span>
                    <h2 class="text-xl font-black text-gray-800 uppercase italic">Poupan√ßa</h2>
                </div>
                {% if partida.Banco.poupanca_trancada %}
                    <span class="px-3 py-1 bg-red-100 text-red-700 text-[9px] font-black rounded-full uppercase">Congelada</span>
                {% else %}
                    <span class="px-3 py-1 bg-green-100 text-green-700 text-[9px] font-black rounded-full uppercase">Liberada</span>
                {% endif %}
            </div>

            <form method="POST" action="{{ url_for('controle_poupanca') }}" class="space-y-6 flex-1 flex flex-col justify-between">
                <button type="submit" name="action" value="{{ 'destrancar' if partida.Banco.poupanca_trancada else 'trancar' }}" 
                    class="w-full py-4 rounded-2xl font-black text-white transition-all shadow-md text-xs
                    {{ 'bg-green-500 hover:bg-green-600' if partida.Banco.poupanca_trancada else 'bg-red-500 hover:bg-red-600' }}">
                    {{ 'DESBLOQUEAR SISTEMA' if partida.Banco.poupanca_trancada else 'BLOQUEAR RESGATES' }}
                </button>

                {% if partida.Banco.poupanca_trancada %}
                <div class="bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-100 border-dashed">
                    <label class="block text-[9px] font-black text-indigo-900 uppercase mb-3 text-center">Rendimento Global de Juros</label>
                    <div class="flex items-center gap-2 mb-4">
                        <input type="number" name="percentual_render" step="0.01" min="-100" max="100" required class="flex-1 bg-white p-4 rounded-xl border-2 border-indigo-200 font-mono text-2xl font-black outline-none focus:border-indigo-500" placeholder="0.00">
                        <span class="text-2xl font-black text-indigo-300">%</span>
                    </div>
                    <button type="submit" name="action" value="render" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black hover:bg-indigo-700 transition-all text-xs uppercase italic">Aplicar Rendimento</button>
                </div>
                {% else %}
                <div class="flex-1 flex items-center justify-center p-6 text-center text-gray-300 italic text-xs">
                    Bloqueie os resgates para realizar a aplica√ß√£o de rendimentos globais.
                </div>
                {% endif %}
            </form>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">üî®</span>
                <h2 class="text-xl font-black text-gray-800 uppercase italic">Leil√£o</h2>
            </div>
            
            {% if LEILAO_ATUAL.ativo %}
                <div class="bg-yellow-50 rounded-2xl p-6 border-2 border-yellow-200 border-dashed text-center">
                    <p class="text-[9px] font-black text-yellow-800 uppercase tracking-widest mb-1">Item em Disputa</p>
                    <h4 class="text-2xl font-black text-gray-800 mb-6 italic">"{{ LEILAO_ATUAL.propriedade }}"</h4>
                    
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                        <p class="text-[9px] font-black text-red-400 uppercase mb-1">Lance Atual</p>
                        <p class="text-3xl font-black text-red-600 font-mono leading-none">R$ {{ LEILAO_ATUAL.lance_atual | format_brl }}</p>
                        <p class="text-[10px] font-bold text-gray-500 mt-3">L√≠der: <span class="text-monopoly-dark font-black uppercase">{{ LEILAO_ATUAL.jogador_atual_nome or '---' }}</span></p>
                    </div>

                    <form method="POST" action="{{ url_for('finalizar_leilao') }}">
                        <button type="submit" class="w-full bg-monopoly-dark text-white font-black py-4 rounded-xl hover:bg-black transition-all shadow-xl active:scale-95 uppercase italic text-xs">Finalizar e Debitar üî®</button>
                    </form>
                </div>
            {% else %}
                <form method="POST" action="{{ url_for('iniciar_leilao') }}" class="space-y-4">
                    <div>
                        <label class="block text-[9px] font-black text-gray-400 uppercase mb-2">Item/Propriedade</label>
                        <input type="text" name="propriedade" required placeholder="Ex: Av. Paulista" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold outline-none focus:border-monopoly-blue">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black text-gray-400 uppercase mb-2">Pre√ßo Inicial (R$)</label>
                        <input type="number" name="lance_inicial" required class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl font-mono text-2xl font-black outline-none focus:border-monopoly-blue">
                    </div>
                    <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-black py-4 rounded-xl shadow-lg transition-all uppercase italic text-xs">Iniciar Preg√£o</button>
                </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleAdj(isFixed) {
    const adjContainer = document.getElementById('ajuste_container');
    const valorLabel = document.getElementById('valor_label');
    const valorInput = document.getElementById('valor_input');
    
    if (isFixed) {
        adjContainer.style.display = 'block';
        adjContainer.style.opacity = '1';
        valorLabel.textContent = 'Valor Nominal (R$)';
    } else {
        adjContainer.style.display = 'none';
        adjContainer.style.opacity = '0';
        valorLabel.textContent = 'Porcentagem do Saldo (%)';
    }
}
</script>
{% endblock %}
